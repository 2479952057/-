<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<title>å‘˜å·¥å·¥ä½œæ—¥å¿— - AIæ™ºèƒ½è¯„åˆ†ç³»ç»Ÿ</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif}
body{background:#f7f8fa;min-height:100vh}
.container{max-width:1000px;margin:0 auto;padding:20px}
.header{background:#1677ff;color:white;padding:20px 24px;border-radius:14px;box-shadow:0 4px 12px rgba(22, 119, 255, 0.15)}
.header h1{font-size:22px;font-weight:600}
.main{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:20px 0}
.card{background:white;padding:24px;border-radius:14px;box-shadow:0 2px 12px rgba(0,0,0,0.05)}
.card h2{margin-bottom:18px;color:#1677ff;font-size:18px;font-weight:600;display:flex;align-items:center;gap:6px}
.form-item{margin-bottom:16px}
label{display:block;margin-bottom:8px;color:#333;font-size:14px;font-weight:500}
input,textarea{width:100%;padding:12px;border:1px solid #d9d9d9;border-radius:8px;font-size:14px;transition:border-color 0.2s, box-shadow 0.2s}
input:focus,textarea:focus{outline:none;border-color:#1677ff;box-shadow:0 0 0 2px rgba(22, 119, 255, 0.1)}
textarea{min-height:100px;resize:vertical;line-height:1.5}
.btn{width:100%;padding:14px;background:#1677ff;color:white;border:none;border-radius:10px;margin-top:10px;font-weight:600;font-size:16px;cursor:pointer;transition:background 0.2s, transform 0.1s}
.btn:disabled{background:#999;cursor:not-allowed;transform:none}
.btn:hover:not(:disabled){background:#0d5bcd}
.btn:active:not(:disabled){transform:scale(0.98)}
.score-item{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f0f0f0;font-size:14px}
.score-item:last-child{border-bottom:none}
.score-item b{color:#1677ff;font-size:15px}
.radar{height:280px;margin:20px 0;width:100%}
.rank-item{display:flex;justify-content:space-between;padding:12px 10px;border-bottom:1px solid #f5f5f5;font-size:14px}
.rank-item:last-child{border-bottom:none}
.rank-item:first-child{font-weight:600;color:#1677ff;background:#f0f7ff;border-radius:6px}
.tips{color:#999;font-size:12px;margin-top:12px;text-align:center;line-height:1.4}
.status-tip{text-align:center;margin-top:10px;font-size:13px;color:#1677ff;font-weight:500}
.key-input{background:#f0f7ff;border:1px solid #1677ff}
.total-box{text-align:center;margin:24px 0;padding:20px;background:#f6ffed;border:1px solid #b7eb8f;border-radius:12px}
.total-box .total-num{font-size:48px;font-weight:700;color:#00b42a;line-height:1}
.total-box .total-desc{margin-top:8px;color:#666;font-size:14px}
#comment{margin-top:16px;line-height:1.6;color:#333;font-size:14px;padding:14px;background:#f8f9fa;border-radius:8px}
/* ç§»åŠ¨ç«¯å…¨é€‚é… */
@media (max-width: 768px) {
  .main{grid-template-columns:1fr}
  .radar{height:240px}
  .header h1{font-size:18px}
  .total-box .total-num{font-size:40px}
  .container{padding:12px}
  .card{padding:18px}
}
/* åŠ è½½åŠ¨ç”» */
.loading{display:inline-block;width:14px;height:14px;border:2px solid #fff;border-radius:50%;border-top-color:transparent;animation:spin 0.8s linear infinite;margin-right:6px}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
<!-- ä¸»CDN+å¤‡ç”¨CDNï¼Œç¡®ä¿å›¾è¡¨åº“100%åŠ è½½æˆåŠŸ -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
// å¤‡ç”¨CDNåŠ è½½å®¹é”™
if(typeof echarts === 'undefined'){
  document.write('<script src="https://lib.baomitu.com/echarts/5.4.3/echarts.min.js"><\/script>');
}
</script>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>å‘˜å·¥å·¥ä½œæ—¥å¿— - AIæ™ºèƒ½è¯„åˆ†ç³»ç»Ÿ</h1>
  </div>
  <div class="main">
    <div class="card">
      <h2>ğŸ“ å·¥ä½œæ—¥å¿—</h2>
      <!-- å¯†é’¥è¾“å…¥æ¡†ï¼šå¯†ç æ¨¡å¼ã€ä¼šè¯çº§ä¸´æ—¶å­˜å‚¨ã€æ°¸ä¸æ°¸ä¹…ä¿å­˜ -->
      <div class="form-item">
        <label>Gemini APIå¯†é’¥ï¼ˆä»…æœ¬åœ°å†…å­˜ä½¿ç”¨ï¼Œå…³é—­é¡µé¢è‡ªåŠ¨æ¸…ç©ºï¼‰</label>
        <input id="apiKey" type="password" class="key-input" placeholder="è¯·è¾“å…¥ä½ è‡ªå·±çš„Gemini APIå¯†é’¥" autocomplete="off">
      </div>
      <div class="form-item">
        <label>å§“å</label>
        <input id="name" placeholder="è¯·è¾“å…¥å§“å" autocomplete="off">
      </div>
      <div class="form-item">
        <label>ä»Šæ—¥å®Œæˆå·¥ä½œ</label>
        <textarea id="done" placeholder="è¯·è¯¦ç»†å¡«å†™ä»Šæ—¥å®Œæˆçš„å·¥ä½œå†…å®¹"></textarea>
      </div>
      <div class="form-item">
        <label>æœªå®Œæˆå·¥ä½œ</label>
        <textarea id="undone" placeholder="è¯·å¡«å†™æœªå®Œæˆçš„å·¥ä½œåŠåŸå› "></textarea>
      </div>
      <div class="form-item">
        <label>é‡åˆ°çš„é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</label>
        <textarea id="problem" placeholder="è¯·å¡«å†™é‡åˆ°çš„é—®é¢˜åŠå¯¹åº”çš„è§£å†³åŠæ³•"></textarea>
      </div>
      <div class="form-item">
        <label>æ˜æ—¥å·¥ä½œè®¡åˆ’</label>
        <textarea id="plan" placeholder="è¯·å¡«å†™æ˜æ—¥çš„å·¥ä½œå®‰æ’ä¸è®¡åˆ’"></textarea>
      </div>
      <button class="btn" onclick="submitAI()" id="btn">ğŸš€ AIæ™ºèƒ½è¯„åˆ†</button>
      <div class="tips">æ¥å…¥Google Geminiå®˜æ–¹åŸç”ŸAPIï¼Œçº¯AIçœŸå®è¯„åˆ†ï¼Œæ— æœ¬åœ°å…œåº•ã€æ— éšæœºæ•°ã€æ— é€ å‡é€»è¾‘</div>
      <div id="statusTip" class="status-tip"></div>
    </div>
    <div class="card">
      <h2>ğŸ“Š AIè¯„åˆ†ç»“æœ</h2>
      <div class="total-box">
        <div class="total-num" id="total">0.00</div>
        <div class="total-desc">æ€»åˆ†ï¼ˆ0.5~4.0ï¼‰</div>
      </div>
      <div class="score-item">å·¥ä½œå®Œæˆåº¦ <b id="s1">0.0</b></div>
      <div class="score-item">æ•ˆç‡ä¸æ‰§è¡ŒåŠ› <b id="s2">0.0</b></div>
      <div class="score-item">è´£ä»»å¿ƒä¸æ€åº¦ <b id="s3">0.0</b></div>
      <div class="score-item">åä½œä¸æ²Ÿé€š <b id="s4">0.0</b></div>
      <div class="score-item">æ”¹è¿›ä¸æˆé•¿ <b id="s5">0.0</b></div>
      <div id="radar" class="radar"></div>
      <p id="comment">è¯·å¡«å†™å·¥ä½œæ—¥å¿—å¹¶ç‚¹å‡»ã€ŒAIæ™ºèƒ½è¯„åˆ†ã€ï¼Œå³å¯è·å–AIä¸“ä¸šè¯„åˆ†ä¸è¯„è¯­</p>
    </div>
  </div>
  <div class="card">
    <h2>ğŸ† å‘˜å·¥è¯„åˆ†æ’å</h2>
    <div id="rankList" style="padding:14px;text-align:center;color:#999">æš‚æ— è¯„åˆ†è®°å½•</div>
  </div>
</div>

<script>
// ===================== å…¨å±€é…ç½®ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰=====================
let chart;
let records = [];
const API_TIMEOUT = 15000; // 15ç§’è¶…æ—¶æ§åˆ¶
const STORAGE_KEY = 'workScoreRecords';
const SESSION_KEY = 'temp_gemini_key';
const MAX_SCORE_PER_DIM = 0.8;
const MIN_SCORE_PER_DIM = 0.1;
const MAX_TOTAL_SCORE = 4.0;
const MIN_TOTAL_SCORE = 0.5;

// ===================== å·¥å…·å‡½æ•°ï¼ˆå…¨å®¹é”™ï¼‰=====================
// æœ¬åœ°å­˜å‚¨å¯ç”¨æ€§æ£€æµ‹
function isStorageAvailable() {
  try {
    const testKey = '__storage_test__';
    localStorage.setItem(testKey, testKey);
    localStorage.removeItem(testKey);
    return true;
  } catch (e) {
    return false;
  }
}

// ä¼šè¯å­˜å‚¨å¯ç”¨æ€§æ£€æµ‹
function isSessionStorageAvailable() {
  try {
    const testKey = '__session_test__';
    sessionStorage.setItem(testKey, testKey);
    sessionStorage.removeItem(testKey);
    return true;
  } catch (e) {
    return false;
  }
}

// HTMLè½¬ä¹‰ï¼Œé˜²æ­¢XSSæ”»å‡»
function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/[&<>"']/g, char => {
    const entities = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
    return entities[char];
  });
}

// ä»æœ¬åœ°å­˜å‚¨è¯»å–è®°å½•
function loadRecordsFromStorage() {
  if (!isStorageAvailable()) return [];
  try {
    const storageData = localStorage.getItem(STORAGE_KEY);
    if (!storageData) return [];
    const parsedData = JSON.parse(storageData);
    return Array.isArray(parsedData) ? parsedData : [];
  } catch (e) {
    console.warn('æœ¬åœ°å­˜å‚¨æ•°æ®è§£æå¤±è´¥ï¼Œå·²è‡ªåŠ¨é‡ç½®', e);
    return [];
  }
}

// ä¿å­˜è®°å½•åˆ°æœ¬åœ°å­˜å‚¨
function saveRecordsToStorage(data) {
  if (!isStorageAvailable()) return false;
  try {
    // å®¹é‡æ£€æµ‹ï¼Œé˜²æ­¢å­˜å‚¨æº¢å‡º
    const dataStr = JSON.stringify(data);
    if (new Blob([dataStr]).size > 4 * 1024 * 1024) {
      console.warn('å­˜å‚¨æ•°æ®è¶…å‡ºå®¹é‡é™åˆ¶ï¼Œå·²æ¸…ç†æ—©æœŸè®°å½•');
      data = data.slice(-50); // ä»…ä¿ç•™æœ€è¿‘50æ¡è®°å½•
    }
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    return true;
  } catch (e) {
    console.warn('æœ¬åœ°å­˜å‚¨ä¿å­˜å¤±è´¥', e);
    return false;
  }
}

// ä¼šè¯çº§å¯†é’¥ä¸´æ—¶ä¿å­˜ï¼ˆå…³é—­é¡µé¢è‡ªåŠ¨æ¸…ç©ºï¼‰
function saveTempKey(key) {
  if (!isSessionStorageAvailable()) return;
  try {
    sessionStorage.setItem(SESSION_KEY, key);
  } catch (e) {
    console.warn('ä¼šè¯å¯†é’¥ä¿å­˜å¤±è´¥', e);
  }
}

// è¯»å–ä¸´æ—¶å¯†é’¥
function getTempKey() {
  if (!isSessionStorageAvailable()) return '';
  try {
    return sessionStorage.getItem(SESSION_KEY) || '';
  } catch (e) {
    return '';
  }
}

// ===================== æ ¸å¿ƒæ¸²æŸ“å‡½æ•° =====================
// é›·è¾¾å›¾åˆå§‹åŒ–&æ›´æ–°
function updateRadarChart(data) {
  if (!chart) return;
  chart.setOption({
    radar: {
      indicator: [
        { name: 'å·¥ä½œå®Œæˆåº¦', max: MAX_SCORE_PER_DIM },
        { name: 'æ•ˆç‡ä¸æ‰§è¡ŒåŠ›', max: MAX_SCORE_PER_DIM },
        { name: 'è´£ä»»å¿ƒä¸æ€åº¦', max: MAX_SCORE_PER_DIM },
        { name: 'åä½œä¸æ²Ÿé€š', max: MAX_SCORE_PER_DIM },
        { name: 'æ”¹è¿›ä¸æˆé•¿', max: MAX_SCORE_PER_DIM }
      ],
      splitNumber: 4,
      shape: 'polygon',
      name: {
        fontSize: 12,
        color: '#333'
      },
      splitArea: {
        areaStyle: {
          color: ['rgba(22, 119, 255, 0.02)', 'rgba(22, 119, 255, 0.05)', 'rgba(22, 119, 255, 0.08)', 'rgba(22, 119, 255, 0.12)']
        }
      }
    },
    series: [{
      type: 'radar',
      data: [{
        value: data,
        name: 'è¯„åˆ†ç»´åº¦',
        itemStyle: { color: '#1677ff' },
        lineStyle: { width: 2 },
        areaStyle: { color: 'rgba(22, 119, 255, 0.25)' }
      }]
    }]
  }, true);
}

// æ’åæ¸²æŸ“
function renderRank() {
  const rankList = document.getElementById('rankList');
  if (records.length === 0) {
    rankList.innerHTML = "æš‚æ— è¯„åˆ†è®°å½•";
    return;
  }
  // æŒ‰æ€»åˆ†é™åºæ’åºï¼Œæ— æ•ˆåˆ†æ•°æŒ‰0å¤„ç†
  const sortedRecords = [...records].sort((a, b) => {
    const scoreA = parseFloat(a.total) || 0;
    const scoreB = parseFloat(b.total) || 0;
    return scoreB - scoreA;
  });
  // æ¸²æŸ“æ’åï¼ŒXSSé˜²æŠ¤
  rankList.innerHTML = sortedRecords.map((item, index) => `
    <div class="rank-item">
      <span>${index + 1}. ${escapeHtml(item.name)}</span>
      <span>${escapeHtml(item.total)} åˆ†</span>
    </div>
  `).join('');
}

// è¯„åˆ†ç»“æœæ¸²æŸ“ï¼ˆä»…AIè¿”å›æœ‰æ•ˆæ•°æ®æ—¶æ‰§è¡Œï¼‰
function showScoreResult(data) {
  // å¡«å……åˆ†æ•°ï¼ŒXSSé˜²æŠ¤
  document.getElementById('s1').innerText = data.score1;
  document.getElementById('s2').innerText = data.score2;
  document.getElementById('s3').innerText = data.score3;
  document.getElementById('s4').innerText = data.score4;
  document.getElementById('s5').innerText = data.score5;
  document.getElementById('total').innerText = data.total;
  document.getElementById('comment').innerText = data.comment;

  // æ›´æ–°é›·è¾¾å›¾
  updateRadarChart([
    parseFloat(data.score1),
    parseFloat(data.score2),
    parseFloat(data.score3),
    parseFloat(data.score4),
    parseFloat(data.score5)
  ]);

  // æ–°å¢è®°å½•
  const newRecord = {
    name: document.getElementById('name').value.trim(),
    total: data.total,
    time: new Date().toLocaleString()
  };
  records.push(newRecord);

  // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
  saveRecordsToStorage(records);

  // æ›´æ–°æ’å
  renderRank();
}

// ===================== æ ¸å¿ƒAIè¯„åˆ†é€»è¾‘ï¼ˆçº¯å®˜æ–¹APIï¼Œæ— ä»»ä½•å…œåº•ï¼‰=====================
async function submitAI() {
  // è·å–è¡¨å•å†…å®¹
  let apiKey = document.getElementById('apiKey').value.trim();
  const name = document.getElementById('name').value.trim();
  const done = document.getElementById('done').value.trim();
  const undone = document.getElementById('undone').value.trim();
  const problem = document.getElementById('problem').value.trim();
  const plan = document.getElementById('plan').value.trim();
  const btn = document.getElementById('btn');
  const statusTip = document.getElementById('statusTip');

  // ä¸¥æ ¼è¡¨å•æ ¡éªŒ
  if (!apiKey) {
    // å°è¯•è¯»å–ä¸´æ—¶å¯†é’¥
    apiKey = getTempKey();
    if (!apiKey) {
      alert('è¯·è¾“å…¥ä½ çš„Gemini APIå¯†é’¥');
      document.getElementById('apiKey').focus();
      return;
    }
    document.getElementById('apiKey').value = apiKey;
  }
  if (!name) {
    alert('è¯·å¡«å†™å§“å');
    document.getElementById('name').focus();
    return;
  }
  if (!done) {
    alert('è¯·å¡«å†™ä»Šæ—¥å®Œæˆå·¥ä½œå†…å®¹');
    document.getElementById('done').focus();
    return;
  }

  // ä¸´æ—¶ä¿å­˜å¯†é’¥ï¼Œå½“å‰ä¼šè¯ä¸ç”¨é‡å¤è¾“å…¥
  saveTempKey(apiKey);

  // æ‹¼æ¥å®˜æ–¹APIåœ°å€
  const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
  // è¶…æ—¶æ§åˆ¶å™¨
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), API_TIMEOUT);

  // æŒ‰é’®çŠ¶æ€é”å®šï¼Œé˜²æ­¢é‡å¤æäº¤
  btn.disabled = true;
  btn.innerHTML = '<span class="loading"></span>AIè¯„åˆ†ä¸­â€¦';
  statusTip.innerText = "æ­£åœ¨è°ƒç”¨Geminiå®˜æ–¹APIï¼Œè¯·å‹¿é‡å¤ç‚¹å‡»â€¦";

  try {
    // æè‡´çº¦æŸçš„promptï¼Œ100%ç¡®ä¿è¿”å›çº¯JSONï¼Œæ— ä»»ä½•å¤šä½™å†…å®¹
    const prompt = `
# è§’è‰²
ä½ æ˜¯ä¸“ä¸šã€ä¸¥è°¨çš„ä¼ä¸šå‘˜å·¥å·¥ä½œè¡¨ç°è¯„åˆ†åŠ©æ‰‹ï¼Œåªè¾“å‡ºçº¯JSONæ ¼å¼æ•°æ®ï¼Œç»å¯¹ä¸èƒ½è¾“å‡ºä»»ä½•å…¶ä»–å†…å®¹ã€è§£é‡Šã€markdownæ ¼å¼ã€ä»£ç å—ã€æ³¨é‡Šã€æ¢è¡Œã€å¤šä½™ç¬¦å·ã€‚

# è¯„åˆ†è§„åˆ™ï¼ˆå¿…é¡»100%ä¸¥æ ¼éµå®ˆï¼‰
1.  è¯„åˆ†ç»´åº¦ï¼šå…±5ä¸ªç»´åº¦ï¼Œæ¯ä¸ªç»´åº¦åˆ†æ•°å¿…é¡»ä¸¥æ ¼åœ¨${MIN_SCORE_PER_DIM}-${MAX_SCORE_PER_DIM}ä¹‹é—´ï¼Œä¿ç•™1ä½å°æ•°
    - score1ï¼šå·¥ä½œå®Œæˆåº¦ï¼Œä»…æ ¹æ®ä»Šæ—¥å®Œæˆå·¥ä½œçš„è½åœ°æ€§ã€å®Œæ•´æ€§ã€å®é™…äº¤ä»˜ç»“æœè¯„åˆ†ï¼Œä¸çœ‹å­—æ•°ï¼Œç©ºè¯å¥—è¯ã€æµæ°´è´¦å¿…é¡»æ‰£åˆ†
    - score2ï¼šæ•ˆç‡ä¸æ‰§è¡ŒåŠ›ï¼Œä»…æ ¹æ®å·¥ä½œæ¨è¿›è¿›åº¦ã€äº¤ä»˜é—­ç¯ã€ä»»åŠ¡å®Œæˆæ•ˆç‡è¯„åˆ†
    - score3ï¼šè´£ä»»å¿ƒä¸æ€åº¦ï¼Œä»…æ ¹æ®å·¥ä½œæ€åº¦ã€æœªå®Œæˆå·¥ä½œçš„æ­£è§†ç¨‹åº¦ã€è´£ä»»æ„è¯†ã€é—®é¢˜åº”å¯¹æ€åº¦è¯„åˆ†
    - score4ï¼šåä½œä¸æ²Ÿé€šï¼Œä»…æ ¹æ®å·¥ä½œä¸­çš„ååŒå¯¹æ¥ã€è·¨æ–¹é…åˆã€é—®é¢˜æ²Ÿé€šçš„æœ‰æ•ˆå†…å®¹è¯„åˆ†
    - score5ï¼šæ”¹è¿›ä¸æˆé•¿ï¼Œä»…æ ¹æ®å·¥ä½œå¤ç›˜ã€é—®é¢˜è§£å†³æ–¹æ¡ˆã€æ˜æ—¥è®¡åˆ’çš„åˆç†æ€§ã€è½åœ°æ€§ã€æˆé•¿æ€§è¯„åˆ†
2.  totalï¼šæ€»åˆ†ï¼Œå¿…é¡»æ˜¯5ä¸ªç»´åº¦åˆ†æ•°çš„ç²¾ç¡®ç®—æœ¯æ€»å’Œï¼Œä¿ç•™2ä½å°æ•°ï¼Œå¿…é¡»ä¸¥æ ¼åœ¨${MIN_TOTAL_SCORE}-${MAX_TOTAL_SCORE}ä¹‹é—´
3.  commentï¼šè¯„è¯­ï¼Œæ ¹æ®æ•´ä½“å·¥ä½œæƒ…å†µï¼Œå†™ä¸€æ®µ50-150å­—çš„ä¸“ä¸šã€ä¸­è‚¯ã€å®¢è§‚çš„å·¥ä½œè¯„è¯­ï¼Œä¸èƒ½æœ‰æç«¯è¡¨è¿°
4.  æ ¸å¿ƒè¦æ±‚ï¼šå¿…é¡»ä¸¥æ ¼æ ¹æ®ç”¨æˆ·æäº¤çš„å·¥ä½œæ—¥å¿—å†…å®¹è¯„åˆ†ï¼Œç»å¯¹ä¸èƒ½éšæœºç”Ÿæˆï¼Œå·¥ä½œå†…å®¹è¶Šæœ‰ä»·å€¼ã€è½åœ°æ€§è¶Šå¼ºã€æ€åº¦è¶Šç«¯æ­£ï¼Œåˆ†æ•°è¶Šé«˜ï¼›å‡‘å­—æ•°ã€æ— æ„ä¹‰é‡å¤ã€ç©ºè¯å¥—è¯å¿…é¡»æ‰£åˆ†
5.  æ ¼å¼è¦æ±‚ï¼šå¿…é¡»è¾“å‡ºçº¯JSONï¼Œä¸èƒ½æœ‰ä»»ä½•å…¶ä»–å†…å®¹ï¼Œé”®åå¿…é¡»ä¸¥æ ¼å’Œç¤ºä¾‹ä¸€è‡´ï¼Œå­—ç¬¦ä¸²å¿…é¡»ç”¨åŒå¼•å·åŒ…è£¹

# ç”¨æˆ·æäº¤çš„å·¥ä½œæ—¥å¿—å†…å®¹
å§“åï¼š${name}
ä»Šæ—¥å®Œæˆå·¥ä½œï¼š${done}
æœªå®Œæˆå·¥ä½œï¼š${undone}
é‡åˆ°çš„é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆï¼š${problem}
æ˜æ—¥å·¥ä½œè®¡åˆ’ï¼š${plan}

# è¾“å‡ºç¤ºä¾‹ï¼ˆå¿…é¡»ä¸¥æ ¼éµå¾ªæ­¤æ ¼å¼ï¼‰
{"score1":"0.6","score2":"0.6","score3":"0.6","score4":"0.6","score5":"0.6","total":"3.00","comment":"å·¥ä½œå®Œæˆæƒ…å†µè‰¯å¥½ï¼Œæ‰§è¡ŒåŠ›è¾¾æ ‡ï¼Œæ€åº¦ç«¯æ­£ï¼Œæœ‰å®Œæ•´çš„å·¥ä½œè§„åˆ’ï¼Œæ•´ä½“è¡¨ç°åˆæ ¼ã€‚"}
    `;

    // è°ƒç”¨å®˜æ–¹APIï¼Œæ— ä»»ä½•ä¸­é—´ç¯èŠ‚
    const response = await fetch(GEMINI_API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: {
          temperature: 0.05, // æè‡´ä½éšæœºæ€§ï¼Œç¡®ä¿åŒæ ·å†…å®¹ç»“æœä¸€è‡´
          responseMimeType: "application/json",
          topP: 0.8,
          topK: 10,
          maxOutputTokens: 1024
        },
        safetySettings: [
          { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
          { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
          { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
          { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
        ]
      }),
      signal: controller.signal
    });

    // æ¥å£è°ƒç”¨å¤±è´¥ï¼Œç²¾å‡†æŠ¥é”™ï¼Œæ— ä»»ä½•å…œåº•
    if (!response.ok) {
      switch (response.status) {
        case 400:
        case 403:
          throw new Error("APIå¯†é’¥æ— æ•ˆï¼Œè¯·æ£€æŸ¥å¯†é’¥æ˜¯å¦æ­£ç¡®ã€æ˜¯å¦åœ¨Google AI Studioå¼€å¯äº†Gemini APIæƒé™");
        case 429:
          throw new Error("APIè°ƒç”¨æ¬¡æ•°è¶…é™ï¼ŒGoogleå…è´¹é¢åº¦æ¯æ—¥åˆ·æ–°ï¼Œè¯·ç¨åé‡è¯•");
        case 500:
        case 503:
          throw new Error("Geminiå®˜æ–¹æœåŠ¡å™¨ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
        default:
          throw new Error(`APIè°ƒç”¨å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}ï¼Œè¯·æ£€æŸ¥ç½‘ç»œç¯å¢ƒä¸å¯†é’¥æƒé™`);
      }
    }

    // è§£æAIè¿”å›æ•°æ®
    const result = await response.json();
    statusTip.innerText = "æ­£åœ¨è§£æAIè¯„åˆ†ç»“æœâ€¦";

    // æ ¡éªŒAIè¿”å›å†…å®¹æœ‰æ•ˆæ€§
    if (!result.candidates || result.candidates.length === 0) {
      if (result.promptFeedback && result.promptFeedback.blockReason) {
        throw new Error("å†…å®¹è¢«AIå®‰å…¨ç³»ç»Ÿæ‹¦æˆªï¼Œè¯·ä¿®æ”¹å·¥ä½œæ—¥å¿—å†…å®¹åé‡è¯•");
      }
      throw new Error("AIæœªè¿”å›æœ‰æ•ˆå†…å®¹ï¼Œè¯·é‡è¯•");
    }
    if (!result.candidates[0].content || !result.candidates[0].content.parts || result.candidates[0].content.parts.length === 0) {
      throw new Error("AIè¿”å›å†…å®¹æ— æ•ˆï¼Œè¯·é‡è¯•");
    }

    // æå–çº¯JSONå†…å®¹ï¼Œå…¼å®¹æ‰€æœ‰å¯èƒ½çš„æ ¼å¼å¼‚å¸¸
    let aiResponseText = result.candidates[0].content.parts[0].text.trim();
    const jsonMatch = aiResponseText.match(/\{[\s\S]*\}/);
    if (!jsonMatch) {
      throw new Error("AIè¿”å›æ ¼å¼å¼‚å¸¸ï¼Œæœªè¯†åˆ«åˆ°æœ‰æ•ˆè¯„åˆ†æ•°æ®ï¼Œè¯·é‡è¯•");
    }
    aiResponseText = jsonMatch[0];

    // è§£æJSONï¼Œå•ç‹¬å®¹é”™
    let scoreData;
    try {
      scoreData = JSON.parse(aiResponseText);
    } catch (e) {
      throw new Error("AIè¿”å›æ•°æ®è§£æå¤±è´¥ï¼Œè¯·é‡è¯•");
    }

    // ä¸¥æ ¼æ ¡éªŒè¿”å›æ•°æ®å®Œæ•´æ€§
    const requiredFields = ['score1', 'score2', 'score3', 'score4', 'score5', 'total', 'comment'];
    const hasAllFields = requiredFields.every(field => scoreData[field] !== undefined && scoreData[field] !== '');
    if (!hasAllFields) {
      throw new Error("AIè¿”å›æ•°æ®ä¸å®Œæ•´ï¼Œç¼ºå°‘å¿…å¡«è¯„åˆ†é¡¹ï¼Œè¯·é‡è¯•");
    }

    // åˆ†æ•°èŒƒå›´å¼ºåˆ¶æ ¡éªŒï¼Œç¡®ä¿100%ç¬¦åˆè§„åˆ™ï¼Œé˜²æ­¢æ¸²æŸ“å¼‚å¸¸
    const scoreFields = ['score1', 'score2', 'score3', 'score4', 'score5'];
    scoreFields.forEach(field => {
      let score = parseFloat(scoreData[field]);
      score = Math.max(MIN_SCORE_PER_DIM, Math.min(MAX_SCORE_PER_DIM, score));
      scoreData[field] = score.toFixed(1);
    });
    // é‡æ–°è®¡ç®—ç²¾ç¡®æ€»åˆ†ï¼Œå½»åº•æœç»AIè®¡ç®—é”™è¯¯
    scoreData.total = scoreFields.reduce((sum, field) => sum + parseFloat(scoreData[field]), 0).toFixed(2);

    // æ‰€æœ‰æ ¡éªŒé€šè¿‡ï¼Œæ¸²æŸ“ç»“æœ
    showScoreResult(scoreData);
    statusTip.innerText = "âœ… Geminiå®˜æ–¹AIçœŸå®è¯„åˆ†å®Œæˆï¼Œç»“æœå·²ç”Ÿæ•ˆ";

  } catch (error) {
    // æ‰€æœ‰å¼‚å¸¸ä»…ç²¾å‡†æŠ¥é”™ï¼Œä¸ç”Ÿæˆä»»ä½•åˆ†æ•°ï¼Œä¸ä¿®æ”¹é¡µé¢æ•°æ®
    if (error.name === 'AbortError') {
      alert("AIè¯„åˆ†å¤±è´¥ï¼šè¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œç¯å¢ƒåé‡è¯•");
      statusTip.innerText = "âŒ è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•";
    } else {
      alert(`AIè¯„åˆ†å¤±è´¥ï¼š${error.message}`);
      statusTip.innerText = "âŒ AIè¯„åˆ†å¤±è´¥ï¼Œè¯·æ ¹æ®æç¤ºä¿®æ­£åé‡è¯•";
    }
  } finally {
    // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
    clearTimeout(timeoutId);
    // æ¢å¤æŒ‰é’®çŠ¶æ€ï¼Œæ— è®ºæˆåŠŸå¤±è´¥éƒ½ä¼šæ‰§è¡Œ
    btn.disabled = false;
    btn.innerText = "ğŸš€ AIæ™ºèƒ½è¯„åˆ†";
  }
}

// ===================== é¡µé¢åˆå§‹åŒ– =====================
window.onload = () => {
  // æ ¡éªŒechartsæ˜¯å¦åŠ è½½æˆåŠŸ
  if (typeof echarts === 'undefined') {
    const statusTip = document.getElementById('statusTip');
    if (statusTip) statusTip.innerText = "âŒ å›¾è¡¨åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œååˆ·æ–°é¡µé¢";
    alert("å›¾è¡¨åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œç¯å¢ƒååˆ·æ–°é¡µé¢");
    return;
  }

  // åŠ è½½æœ¬åœ°å­˜å‚¨çš„è®°å½•
  records = loadRecordsFromStorage();

  // åˆå§‹åŒ–é›·è¾¾å›¾
  chart = echarts.init(document.getElementById('radar'));
  updateRadarChart([0, 0, 0, 0, 0]);

  // åˆå§‹åŒ–æ’å
  renderRank();

  // è¯»å–ä¸´æ—¶å¯†é’¥ï¼Œä¸ç”¨é‡å¤è¾“å…¥
  const tempKey = getTempKey();
  if (tempKey) {
    document.getElementById('apiKey').value = tempKey;
  }

  // çª—å£å¤§å°å˜åŒ–ï¼Œé›·è¾¾å›¾è‡ªé€‚åº”
  window.addEventListener('resize', () => {
    if (chart) chart.resize();
  });

  // é¡µé¢å¸è½½ï¼Œé”€æ¯é›·è¾¾å›¾ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
  window.addEventListener('beforeunload', () => {
    if (chart) chart.dispose();
  });

  // å›è½¦æäº¤ä¼˜åŒ–
  document.querySelectorAll('input, textarea').forEach(item => {
    item.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && e.ctrlKey) {
        submitAI();
      }
    });
  });
};
</script>
</body>
</html>
